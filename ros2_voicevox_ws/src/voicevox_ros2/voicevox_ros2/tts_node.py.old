import os
import io

import numpy as np
import sounddevice as sd
import soundfile as sf

import rclpy
from rclpy.node import Node
from std_msgs.msg import String

from voicevox_core.blocking import Onnxruntime, OpenJtalk, Synthesizer, VoiceModelFile


class VoicevoxTTSNode(Node):
    def __init__(self):
        super().__init__("voicevox_tts_node")

        # --- パラメータ ---
        self.declare_parameter(
            "engine_dir", "/home/roboworks/voicevox_engine"
        )
        self.declare_parameter("vvm_file", "0.vvm")
        self.declare_parameter("style_id", 0)

        engine_dir = self.get_parameter("engine_dir").get_parameter_value().string_value
        vvm_file = self.get_parameter("vvm_file").get_parameter_value().string_value
        self.style_id = (
            self.get_parameter("style_id").get_parameter_value().integer_value
        )

        self.get_logger().info(f"engine_dir: {engine_dir}")
        self.get_logger().info(f"vvm_file : {vvm_file}")
        self.get_logger().info(f"style_id : {self.style_id}")

        # --- VOICEVOX Core の初期化 ---
        try:
            onnxruntime_path = os.path.join(
                engine_dir, "onnxruntime", "lib", Onnxruntime.LIB_VERSIONED_FILENAME
            )
            open_jtalk_dict_dir = os.path.join(
                engine_dir, "dict", "open_jtalk_dic_utf_8-1.11"
            )
            vvm_path = os.path.join(engine_dir, "models", "vvms", vvm_file)

            self.get_logger().info(f"onnxruntime: {onnxruntime_path}")
            self.get_logger().info(f"open_jtalk : {open_jtalk_dict_dir}")
            self.get_logger().info(f"vvm       : {vvm_path}")

            # 1. Synthesizer 初期化
            onnx = Onnxruntime.load_once(filename=onnxruntime_path)
            openjtalk = OpenJtalk(open_jtalk_dict_dir)
            self.synthesizer = Synthesizer(onnx, openjtalk)

            # 2. 音声モデル読み込み
            with VoiceModelFile.open(vvm_path) as model:
                self.synthesizer.load_voice_model(model)

            self.get_logger().info("VOICEVOX Synthesizer 初期化完了")

        except Exception as e:
            self.get_logger().error(f"VOICEVOX 初期化に失敗しました: {e}")
            raise

        # --- 購読設定 ---
        # /tts_text に String メッセージが来たら読み上げる
        self.subscription = self.create_subscription(
            String, "tts_text", self.on_text_received, 10
        )

    def on_text_received(self, msg: String):
        text = msg.data
        if not text:
            return

        self.get_logger().info(f"TTS: 「{text}」")

        try:
            # 3. テキストから WAV (bytes) 生成
            wav_bytes = self.synthesizer.tts(text, self.style_id)

            # 4. バッファから直接再生
            data, samplerate = sf.read(io.BytesIO(wav_bytes), dtype="int16")
            data = np.asarray(data)

            sd.play(data, samplerate)
            sd.wait()

        except Exception as e:
            self.get_logger().error(f"TTS 再生中にエラー: {e}")


def main(args=None):
    rclpy.init(args=args)
    node = VoicevoxTTSNode()
    try:
        rclpy.spin(node)
    finally:
        node.destroy_node()
        rclpy.shutdown()


if __name__ == "__main__":
    main()

